# Using Lifelong Learning in Campus Robot Delivery Scenario

## Introduction
This example introduces how to use Sedna lifelong learning to implement the lifelong learning delivery task of the robot in the campus.

This demo mainly shows:
1. Lifelong learning unseen task recognition algorithm (prediction) can identify and collect unseen task samples.
2. Lifelong learning unseen task recognition algorithm (detection) can trigger alarms to remind robot admin that emergency response is required.
3. Lifelong learning unseen task training algorithm improves the inference accuracy of known categories and the ability to identify new categories.

## System Architecture

### Install Sedna
Follow the [Sedna installation document](/docs/setup/install.md) to install Sedna.

### Prepare Dataset 
Step1: download [data.txt](https://kubeedge.obs.cn-north-1.myhuaweicloud.com/sedna-robo/robo_dataset/data.txt)
and upload it to a specfied s3 directory. In this example, the directory is s3://kubeedge/sedna-robo/sedna_data.

Step2: download and decompress [sedna_data.zip](https://kubeedge.obs.cn-north-1.myhuaweicloud.com/sedna-robo/sedna_data.zip), 
then upload the training images in it to the s3 directory where data.txt is stored.

Step3: download [test data](https://kubeedge.obs.cn-north-1.myhuaweicloud.com/examples/robo_dog_delivery/test_data.zip) which is for demonstration at the inference stage, unzip test_data.zip and put it into /data of $INFER_NODE. Or you can use ```docker exec``` to get into $INFER_NODE and then execute the following commands.
```
mkdir /data
cd /data
wget https://kubeedge.obs.cn-north-1.myhuaweicloud.com/examples/robo_dog_delivery/test_data.zip
unzip test_data.zip
```

### Prepare Images
This example uses these images:
1. training worker:  docker.io/luosiqi/sedna-robo:v0.1.1
2. evaluate worker:  docker.io/luosiqi/sedna-robo:v0.1.1
3. inference worker: docker.io/luosiqi/sedna-robo:v0.1.1

These images are generated by the script [build_images.sh](/examples/build_image.sh).

### Create Lifelong Learning Job

#### Preparations
Before this, user need to provide an s3 directory for storage which is denoted as "s3_prefix" in this example, by setting environment variable s3_prefix.
```
s3_prefix=s3://kubeedge/sedna-robo
cloud_image=docker.io/luosiqi/sedna-robo:v0.1.1
edge_image=docker.io/luosiqi/sedna-robo:v0.1.1
data_url=$s3_prefix/robo_dataset/data.txt

DATA_NODE=sedna-mini-control-plane 
TRAIN_NODE=sedna-mini-control-plane
EVAL_NODE=sedna-mini-control-plane
INFER_NODE=sedna-mini-control-plane
OUTPUT=$s3_prefix/lifelonglearningjob/output
job_name=robo-demo
```
#### Create s3 storage resources
Before this, users must generate the S3_ENDPOINT, ACCESS_KEY_ID and SECRET_ACCESS_KEY of their own s3 accounts and set environment
 variables S3_ENDPOINT, ACCESS_KEY_ID and SECRET_ACCESS_KEY.
```
S3_ENDPOINT=obs.cn-north-1.myhuaweicloud.com
ACCESS_KEY_ID=8CH9JVNJF6TGK2IAYUDR

action=${1:-create}

kubectl $action -f - <<EOF
apiVersion: v1
stringData:
  ACCESS_KEY_ID: $ACCESS_KEY_ID
  SECRET_ACCESS_KEY: $SECRET_ACCESS_KEY
kind: Secret
metadata:
  name: my
  annotations:
    s3-endpoint: ${S3_ENDPOINT:-play.min.io}
type: Opaque
EOF
```

#### Create Initial Dataset Resource 
```
kubectl $action -f - <<EOF
apiVersion: sedna.io/v1alpha1
kind: Dataset
metadata:
  name: lifelong-dataset-robo
spec:
  url: "$data_url"
  format: "txt"
  nodeName: "$DATA_NODE"
  credentialName: my
EOF
```

#### Create robot-dog-delivery Lifelong Learning Job
```
action=${1:-create}

kubectl $action -f - <<EOF
apiVersion: sedna.io/v1alpha1
kind: LifelongLearningJob
metadata:
  name: $job_name
spec:
  dataset:
    name: "lifelong-dataset-robo"
    trainProb: 0.8
  trainSpec:
    template:
      spec:
        nodeName: $TRAIN_NODE
        dnsPolicy: ClusterFirstWithHostNet
        containers:
          - image: $cloud_image
            name:  train-worker
            imagePullPolicy: IfNotPresent
            # command: ["bash", "-c"]
            # args: ["while true; do sleep 2000; done;"]
            args: ["train.py"]
            env:
              - name: "train_ratio"
                value: "0.9"
            resources:
              limits:
                cpu: 6
                memory: 12Gi
              requests:
                cpu: 6
                memory: 12Gi
            volumeMounts:
            - mountPath: /dev/shm
              name: cache-volume
        volumes:
        - emptyDir:
            medium: Memory
            sizeLimit: 128Mi
          name: cache-volume
    trigger:
      checkPeriodSeconds: 30
      timer:
        start: 00:00
        end: 24:00
      condition:
        operator: ">"
        threshold: 100
        metric: num_of_samples
  evalSpec:
    template:
      spec:
        nodeName: $EVAL_NODE
        dnsPolicy: ClusterFirstWithHostNet
        containers:
          - image: $cloud_image
            name:  eval-worker
            imagePullPolicy: IfNotPresent
            args: ["evaluate.py"]
            env:
              - name: "operator"
                value: "<"
              - name: "model_threshold"  # Threshold for filtering deploy models
                value: "0"
            resources:
              limits:
                cpu: 6
                memory: 10Gi
              requests:
                cpu: 4
                memory: 10Gi
  deploySpec:
    template:
      spec:
        nodeName: $INFER_NODE
        dnsPolicy: ClusterFirstWithHostNet
        hostNetwork: true
        containers:
        - image: $edge_image
          name:  infer-worker
          imagePullPolicy: IfNotPresent
          # command: ["bash", "-c"]
          # args: ["while true; do sleep 2000; done;"]
          args: ["predict.py"]
          env:
            - name: "test_data"
              value: "/home/data/test_data"
            - name: "unseen_save_url"
              value: "s3://kubeedge/sedna-robo/unseen_samples/"
            - name: "metadata_url"
              value: "s3://kubeedge/sedna-robo/metadata/"
            - name: "OOD_model"
              value: "s3://kubeedge/sedna-robo/models/garden.model"
            - name: "OOD_thresh"
              value: "0.1"
            - name: "robo_skill"
              value: "curb_detection"
            - name: "ramp_detection"
              value: "s3://kubeedge/sedna-robo/models/ramp_train1_200.pth"
            - name: "curb_detection"
              value: "s3://kubeedge/sedna-robo/models/garden.pth"
            - name: "stage"
              value: "inference"
            - name: "INFERENCE_RESULT_DIR"
              value: "/home/data/infer_results"
          volumeMounts:
            - name: inferdata
              mountPath: /home/data/infer_results
            - name: testdata
              mountPath: /home/data/test_data
          resources:  # user defined resources
            limits:
              cpu: 6
              memory: 10Gi
            requests:
              cpu: 4
              memory: 10Gi
        volumes:   # user defined volumes
          - name: inferdata
            hostPath:
              path:  /data/infer_results
              type: DirectoryOrCreate
          - name: testdata
            hostPath:
              path:  /data/test_data
              type: DirectoryOrCreate

  credentialName: my
  outputDir: $OUTPUT/$job_name
EOF
```

### Check Lifelong Learning Status

```
kubectl get lifelonglearningjob
```

### Effect Display





