# Using Lifelong Learning in Campus Robot Delivery Scenario

## Introduction
This example introduces how to use Sedna lifelong learning to implement the lifelong learning delivery task of the robot in the campus.

This demo mainly shows:
1. Lifelong learning unseen task recognition algorithm (prediction) can identify and collect unseen task samples.
2. Lifelong learning unseen task recognition algorithm (detection) can trigger alarms to remind robot admin that emergency response is required.
3. Lifelong learning unseen task training algorithm improves the inference accuracy of known categories and the ability to identify new categories.

## System Architecture

### Install Sedna
Follow the [Sedna installation document](/docs/setup/install.md) to install Sedna.

### Prepare Dataset 
Step1: download [data.txt](https://kubeedge.obs.cn-north-1.myhuaweicloud.com:443/sedna-robo/data.txt?AWSAccessKeyId=EMPTKHQUGPO2CDUFD2YR&Expires=1697698966&Signature=s42sKZVewIP/kgLc4dEzjNCRXfk%3D)
and upload it to a specfied s3 directory.

Step2: download and decompress [sedna_data.zip], then upload the training images to the s3 directory where data.txt is stored.

### Prepare Images
This example uses these images:

1. training worker:  swr.huaweicloud.com/xxx:v0.x.x
2. evaluate worker:  swr.huaweicloud.com/xxx:v0.x.x
3. inference worker: swr.huaweicloud.com/xxx:v0.x.x

These images are generated by the script [build_images.sh](/examples/build_image.sh).


### Create Lifelong Learning Job

#### Preparations
```
s3_prefix=s3://kubeedge/sedna-robo
image=swr.cn-south-1.myhuaweicloud.com/sedna/sedna-robo:v0.1.0
data_url=s3://kubeedge/sedna-robo/sedna_data/data.txt

DATA_NODE=sedna-mini-control-plane 
TRAIN_NODE=sedna-mini-control-plane
EVAL_NODE=sedna-mini-control-plane
INFER_NODE=sedna-mini-control-plane # edge0
OUTPUT=$s3_prefix/lifelonglearningjob/output
job_name=robo-demo
```
#### Create S3 storage resources
```
S3_ENDPOINT=obs.cn-north-1.myhuaweicloud.com
ACCESS_KEY_ID=BHS8QFNIZ8TYNZJQ63ET
action=${1:-create}

kubectl $action -f - <<EOF
apiVersion: v1
stringData:
  ACCESS_KEY_ID: ${ACCESS_KEY_ID:-BHS8QFNIZ8TYNZJQ63ET}
  SECRET_ACCESS_KEY: ${SECRET_ACCESS_KEY:-sxnlBZfzXyDzHcY5lZTrNkXNrrgIY0GXMlqdVZhP}
kind: Secret
metadata:
  name: my
  annotations:
    s3-endpoint: ${S3_ENDPOINT:-play.min.io}
type: Opaque
EOF
```

#### Create Initial Dataset Resource 
```
kubectl $action -f - <<EOF
apiVersion: sedna.io/v1alpha1
kind: Dataset
metadata:
  name: lifelong-dataset-robo
spec:
  url: "$data_url"
  format: "txt"
  nodeName: "$DATA_NODE"
  credentialName: my
EOF
```

#### Create robot-dog-delivery Lifelong Learning Job
```
action=${1:-create}

kubectl $action -f - <<EOF
apiVersion: sedna.io/v1alpha1
kind: LifelongLearningJob
metadata:
  name: $job_name
spec:
  dataset:
    name: "lifelong-dataset-robo"
    trainProb: 0.8
  trainSpec:
    template:
      spec:
        nodeName: $TRAIN_NODE
        dnsPolicy: ClusterFirstWithHostNet
        containers:
          - image: $image
            name:  train-worker
            imagePullPolicy: IfNotPresent
            args: ["sedna_train.py"]
            env:
              - name: "train_ratio"
                value: "0.9"
              - name: "BACKEND_TYPE"
                value: "PYTORCH"
            resources:
              limits:
                cpu: 6
                memory: 6Gi
              requests:
                cpu: 3
                memory: 3Gi
            volumeMounts:
            - mountPath: /dev/shm
              name: cache-volume
        volumes:
        - emptyDir:
            medium: Memory
            sizeLimit: 128Mi
          name: cache-volume
    trigger:
      checkPeriodSeconds: 30
      timer:
        start: 00:00
        end: 24:00
      condition:
        operator: ">"
        threshold: 100
        metric: num_of_samples
  evalSpec:
    template:
      spec:
        nodeName: $EVAL_NODE
        dnsPolicy: ClusterFirstWithHostNet
        containers:
          - image: $image
            name:  eval-worker
            imagePullPolicy: IfNotPresent
            args: ["sedna_evaluate.py"]
            env:
              - name: "operator"
                value: "<"
              - name: "model_threshold"  # Threshold for filtering deploy models
                value: "0"
              - name: "BACKEND_TYPE"
                value: "PYTORCH"
            resources:
              limits:
                cpu: 6
                memory: 6Gi
              requests:
                cpu: 3
                memory: 3Gi
  deploySpec:
    template:
      spec:
        nodeName: $INFER_NODE
        dnsPolicy: ClusterFirstWithHostNet
        containers:
        - image: $image
          name:  infer-worker
          imagePullPolicy: IfNotPresent
          args: ["robo_infer_service.py"]
          env:
          - name: "PREDICT_RESULT_DIR"
            value: "/data"
          - name: "unseen_save_url"
            value: "/ut_saved_url"
          - name: "BACKEND_TYPE"
            value: "PYTORCH"
          volumeMounts:
          - name: utdir
            mountPath: /ut_saved_url
          - name: inferdata
            mountPath: /data/
          resources:  # user defined resources
            limits:
              cpu: 6
              memory: 6Gi
            requests:
              cpu: 3
              memory: 3Gi
        volumes:   # user defined volumes
          - name: utdir
            hostPath:
              path: /lifelong/unseen_task/
              type: DirectoryOrCreate
          - name: inferdata
            hostPath:
              path:  /lifelong/data/
              type: DirectoryOrCreate

  credentialName: my
  outputDir: $OUTPUT/$job_name
EOF
```

### Check Lifelong Learning Status

```
kubectl get lifelonglearningjob
```

### Effect Display





